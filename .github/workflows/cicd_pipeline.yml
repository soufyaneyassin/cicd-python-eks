name: CI/CD python app Pipeline
on:
  push:
      branches:
          - dev
          - main
  pull_request:
      branches:
          - dev
          - main

jobs:
   test_code:
      runs-on: ubuntu-latest
      steps:
         - name: Checkout only python_app folder
           uses: actions/checkout@v6
           with:
             sparse-checkout: |
                python_app/
             sparse-checkout-cone-mode: false
         - name: Setup python environment
           uses: actions/setup-python@v6         
           with:
              python-version: '3.13'
              cache: 'pip'
         - run: ls && cd python_app && pip install .
         - name: Run Tests
           run: pytest
   build_and_push:
        needs: test_code
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Only python app
              uses: actions/checkout@v6
              with:
                sparse-checkout: |
                     python_app/
                sparse-checkout-cone-mode: false
            - name: Setup env variables
              run: |
                 echo "ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}" >> $GITHUB_ENV
                 echo $GITHUB_REF_NAME